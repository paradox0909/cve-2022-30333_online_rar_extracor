<?php

define("UNRAR", "./bin/rar/unrar");

function tempdir() {
    $tempfile=tempnam(sys_get_temp_dir(),'');
    if (file_exists($tempfile)) { unlink($tempfile); }
    mkdir($tempfile);
    if (is_dir($tempfile)) { return $tempfile; }
}

function random_filename(){
    return sha1(rand()*rand()*rand()); // To-do
}

function RARextract($src, $dest){
    if(file_exists(UNRAR)){
      return shell_exec(UNRAR . " e -y " . escapeshellarg($src) . " " . escapeshellarg($dest));
    }else{
      die("ERROR !");
    }
}

function dirToArray($dir) {
   $result = array();
   $cdir = scandir($dir);
   foreach ($cdir as $key => $value){
      if (!in_array($value,array(".",".."))){
         if (is_dir($dir . DIRECTORY_SEPARATOR . $value)){
            $result[$value] = dirToArray($dir . DIRECTORY_SEPARATOR . $value);
         }else{
            $result[] = $value;
         }
      }
   }
   return $result;
}

  $filetype = mime_content_type($_FILES["file"]["tmp_name"]);
  if($filetype != 'application/x-rar') die('Invalid RAR File.');

  $backup = "./upload/".random_filename().".rar";
  copy($_FILES["file"]["tmp_name"], $backup); // backup 

  $tmpdir = tempdir();
  $out = RARextract($_FILES["file"]["tmp_name"], $tmpdir);
  $scanout = dirToArray($tmpdir);
  // To-do: Download extract file.
?>
<html>
    <head></head>
    <link rel="stylesheet" href="/static/bulma.min.css" />
    <body>
        <div class="container card">
            <div class="card-content">
                <div class="columns">
                    <div class="column">
                        <h1 class="title">Online <a href="https://en.wikipedia.org/wiki/RAR_(file_format)" target="_blank">RAR</a> Extractor Result</h1>
                    </div>
                </div>
                <div>
                    <nav class="panel">
                        <p class="panel-heading"><?=htmlspecialchars($_FILES["file"]["name"]);?></p>
                        <?php
                          foreach($scanout as $file){
                            echo "<p class='panel-block'>".htmlspecialchars($file)."</p>";
                          }
                        ?>
                    </nav>
                </div>
            </div>
        </div>
    </body>
</html>
